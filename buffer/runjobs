# This script actually runs the RAT jobs found in the jobqueue file.
# On start-up, it reconstructs the queue since old jobs are otherwise
# never flushed.  It writes out the stdout output of RAT to batch.log.

#! /bin/bash
DIRLOCAL=$(dirname $0)
LOG=$1
DIR=$2

source ~/rat_env.sh

# First reconstruct the job queue
if [ "$(ls $DIR/*/zdab/* | wc -l)" -gt 0 ]
then
  killall -SIGUSR1 chopper
  sleep 1
  rm $DIRLOCAL/jobqueue.txt
  for i in $(ls $DIR/*/zdab/* | wc -l)
  do
    SUBRUN=$(cat $i | awk 'BEGIN {FS="/"}{print $2}' )
    INDEX=$(cat $i | awk 'BEGIN {FS="/"}{print $4}' | \
            awk 'BEGIN {FS="_"}{print $2}' )
    echo ./job $SUBRUN $INDEX $i >> $DIRLOCAL/jobqueue.txt
  done
  killall -SIGUSR2 chopper
fi

# Then run the jobs
tail -f -c +1 $DIRLOCAL/jobqueue.txt | parallel -j4 --retries 4 --progress \
   >> $LOG

