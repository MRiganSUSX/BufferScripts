#!/bin/bash

# This client script receives newly-built files from the server script
# and (1) writes them out to the Buffer and (2) feeds them to the chopper.
# When the chopper has run to completion, it touches the file filereceived
# on the Buffer to advance the server.  There is a client log that records
# the output of the Chopper as well as statements when files are complete.
# The client also writes a joblog file for each builder file at
# $RUN.chopper.log to record the job numbers associated to that file.

# This script is designed for use with the L2 Master Script.  It can be run
# independently by giving it the arguments listed below:

# Specifying where things are located
BUILDER=$1
PIPE=$2
L1=$3
LOG=$4
CHOPPER=$5
JOBQUEUE=$6
MAC=$7
PASSWORDFILE=$8
GRIDREADY=$9
PCAFILE=~/run.txt
SERVERDIR=~/bufferscripts/builder

# This function is a wrapper for Stonehenge, which will send the appropriate
# signals to the server
chopper()
{
$CHOPPER -i /dev/stdin -o $NAME -r $PASSWORD -c ~/chopper/default.cnfg >> $LOG
echo DEBUG - Stonehenge has exited.
if [ $? -eq 0 ]
then
  echo SUCCESS - Stonehenge finished processing file $FILE successfully.
  ssh $BUILDER touch $SERVERDIR/filereceived 
  TRIES=0
else
  TRIES=$( $TRIES + 1)
  echo WARNING - Stonehenge exited on file $FILE.
  if [ $TRIES -lt 3 ]
  then
    echo INFO - Trying to read file $FILE again.
    ssh $BUILDER touch $SERVERDIR/filetryagain
  else
    echo ERROR - Three failured trying to process file $FILE.  Moving on.
    ssh $BUILDER touch $SERVERDIR/filefailed
  fi
fi
}

echo SUCCESS - L2 Client starting
while true
do
    TRIES=0
# For each file coming from the builder, first receive the filename
# then, receive the file; finally, write the item into the jobqueue

# Receive and parse filename
    FILE=$(ssh $BUILDER cat $PIPE)
    echo INFO - Receiving file $FILE
    RUN=$( echo $FILE | awk 'BEGIN {FS="_"}{print $2}' )
    echo $RUN > $PCAFILE
    SUBRUN=$( echo $FILE | awk 'BEGIN {FS="_"}{print $3}' )
    BIGFILE=$( echo $FILE | awk 'BEGIN {FS="/"}{print $6}' )
    NAME=$RUN"_"$SUBRUN 
    PASSWORD=$(cat $PASSWORDFILE)
    
# Receive file - try three times, report errors
    ssh $BUILDER cat $PIPE | tee -a $L1/$BIGFILE \
                           | chopper

# Prepare for conversion
    cat > $MAC/$NAME.mac << EOF

/PhysicsList/OmitAll true

/run/initialize

/rat/proclast outroot
/rat/procset file "$NAME.l2.root"

/rat/inzdab/read $NAME.zdab

exit
EOF

    echo ~/bufferscripts/buffer/job $MAC $RUN_$SUBRUN $NAME.zdab $GRIDREADY >> $JOBQUEUE
    echo SUCCESS - Stonehenge done with run $RUN"_"$SUBRUN

    sleep 1
done
