#!/bin/bash

# This script collects together the small files of events passing the L2
# filter into a single large file for storage.  The list of files it uses
# is ###.chopper.log, which is actually written by the client script.
# Also responsible for general upkeep.

output=$1
DATADIR=$2
LS=$3
ERRORLIST=$4
FL=$5

# This function will set the value of SUBRUN to the name of the next 
# subrun needing gluing
function NextSubrun {
# Get list of subruns needing to be reassembled
ls $DATADIR > $LS
for i in $LS
do
    if [ ! -f $output/$i ]
    then
# Ensure candidate is not on list of skipped subruns
        if [ $(grep $ERRORLIST $i | wc -l) -eq 0 ]
        then
            SUBRUN=$i
            break
        fi
    fi
done
}


while true
do

    # Get next available subrun
    NextSubrun

    # Check whether all files are processed
    num=$(ls $DATADIR/$SUBRUN/zdab | wc -l)
    COUNT=0
    while [ "$num" -gt 0 ]
    do
        echo $num files remaining to process in subrun $SUBRUN.
        sleep 1
        num2=$(ls $DATADIR/$SUBRUN/zdab | wc -l)
        if [ "$num2" = "$num" ]
        then
            COUNT+=1
        fi
        if [ "$num2" -lt "$num" ]
        then
            COUNT=0
        fi
        num=$num2
        if [ "$COUNT" -gt 60 ]
        then
            echo ERROR: Files for run $SUBRUN are not getting processed.
            echo ERROR: Please correct the problem.
            echo Gluer moving on to next $SUBRUN.
            cat $SUBRUN >> $ERRORLIST
            NextSubrun #Skip to next subrun
        fi
    done

    # Prepare RAT macro for gluing files
    # First, make a list of all files
    ls $DATADIR/$SUBRUN/rat > $FL

    # Write macro body
    cat > $DATADIR/$SUBRUN/gluer.mac << EOF

/PhysicsList/OmitAll
/rat/db/set DETECTOR geo_file "geo/empty.geo"

/run/initialize

/rat/proc outroot
/rat/procset file $output/$SUBRUN

EOF
    
    # Add read lines for each file on our list
    for i in $FL
    do
        echo /rat/read inzdab $DATADIR/$SUBRUN/rat/$i \
             >> $DATADIR/$SUBRUN/gluer.mac
    done

    # Run job and clean up files
    source rat_env.sh
    if rat $DATADIR/$SUBRUN/gluer.mac
    then
        rm $DATADIR/$SUBRUN/gluer.mac
        for i in $FL
        do
            rm $DATADIR/$SUBRUN/rat/$i
        done
    else
        echo ERROR: Gluer RAT job has failed!  You need to try recombining \
              chopped files again!
    fi

done
