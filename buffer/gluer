# This script collects together the small files of events passing the L2
# filter into a single large file for storage.  The list of files it uses
# is ###.chopper.log, which is actually written by the client script.
# Also responsible for general upkeep.

#! /bin/bash

output=$1

while true
do

    OLDRUN=0
    OLDFILE=$(ls -t buffer | grep .chopper.log | tail -n 1)
    RUN=$( cat $OLDFILE | awk 'BEGIN {FS="."}{print $1}' )
    NEWFILE=($RUN+1).chopper.log

    while [ ! -f $NEWFILE ]
    do
        sleep 1
    done

    OLDRUN=$RUN
    RUN=$RUN+1
    BIGFILE=$RUN.L2.root
    FIRST=0

    for i in `cat $OLDFILE`
    do
        FILTER="chopped_$i_1.00_0.00.zdab.root "
        COUNT=0
        while [ ! -f $FILTER ]
        do
            if [ "$COUNT" -gt 60 ]
            then
                echo Gluer Error: Human Operator, where are my files?
            fi
            sleep 10
            COUNT+=1
        done
        if [ "$FIRST" -eq 0 ]
        then
            ARGS=$FILTER
            FIRST=1
        else

#
#            cat > /tmp/rootmacro.C << EOF
#
#{
#    TFile* file = new TFile("$FILTER","update);
#    gDirectory->Delete("macro;1");
#    gDirectory->Delete("log;1");
#    gDirectory->Delete("db;1");
#    gDirectory->Delete("runT;1");
#    file->Close();
#}
#
#EOF
#            root -b -q /tmp/rootmacro.C
#            rm /tmp/rootmacro.C
#            ARGS+=$FILTER

         cat > /tmp/gluer.mac << EOF

/PhysicsList/OmitAll
/rat/db/set DETECTOR geo_file "geo/empty.geo"

/run/initialize

/rat/proc outroot
/rat/procset file $NAME

/rat/inroot read $FILE

EOF
     fi
     done
#    hadd $BIGFILE $ARGS

done
